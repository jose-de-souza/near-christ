<div class="user-maintenance">
    <h2>User Maintenance</h2>

    <!-- Form container -->
    <div class="form-container">
        <!-- User Details Section -->
        <div class="section user" data-title="User Details">
            <div class="row-user">
                <!-- User Name -->
                <div class="field-group user-name">
                    <label>User Name</label>
                    <!-- CORRECTED: Use userName -->
                    <input type="text" [(ngModel)]="selectedUser.userName" autocomplete="off" />
                    <div *ngIf="hasSubmitted && !selectedUser.userName?.trim()" class="inline-error">
                        User Name is required.
                    </div>
                </div>

                <!-- Email -->
                <div class="field-group user-email">
                    <label>Email</label>
                    <input type="email" [(ngModel)]="selectedUser.userEmail" autocomplete="off" />
                    <div *ngIf="hasSubmitted && !selectedUser.userEmail?.trim()" class="inline-error">
                        Email is required.
                    </div>
                </div>

                <!-- Password -->
                <div class="field-group user-password">
                    <label>Password</label>
                    <input type="password" [(ngModel)]="selectedUser.password" placeholder="Leave blank to keep unchanged" autocomplete="new-password" />
                    <!-- CORRECTED: Use selectedUser.id -->
                    <div *ngIf="hasSubmitted && !selectedUser.id && !selectedUser.password?.trim()"
                        class="inline-error">
                        Password is required for new users.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Roles Section -->
        <div class="section roles" data-title="Roles">
             <div class="field-group user-roles">
                <label>Roles</label>
                <!-- REPLACED: Dropdown is now a checkbox group for multiple roles -->
                <div class="checkbox-group">
                    <mat-checkbox *ngFor="let role of allRoles"
                                  [checked]="selectedRoles.get(role)"
                                  (change)="selectedRoles.set(role, $event.checked)">
                        {{ role }}
                    </mat-checkbox>
                </div>
                 <div *ngIf="hasSubmitted && selectedRolesCount === 0" class="inline-error">
                    At least one role is required.
                </div>
            </div>
        </div>
    </div>
    <!-- end form-container -->

    <!-- Buttons -->
    <div class="buttons">
        <button (click)="addUser()" [disabled]="uiMode === 'editing'">Add</button>
        <button (click)="modifyUser()" [disabled]="uiMode !== 'editing'">Modify</button>
        <button (click)="deleteUser()" [disabled]="uiMode !== 'editing'">Delete</button>
        <button (click)="cancel()" [disabled]="uiMode === 'view'">Cancel</button>
    </div>

    <!-- Results Area: Grid -->
    <div class="results-area">
        <div class="grid-table" cdkDropList cdkDropListOrientation="horizontal" [cdkDropListData]="columns"
            (cdkDropListDropped)="onDrop($event)" [style.gridTemplateColumns]="gridTemplateColumns">
            <div class="grid-column" *ngFor="let column of columns; trackBy: trackByColumn" cdkDrag>
                <div class="grid-column-header">
                    <span class="drag-handle" cdkDragHandle>â˜°</span>
                    {{ column.header }}
                </div>
                <div class="grid-column-cell" *ngFor="let row of users; trackBy: trackByUserID"
                    (click)="selectUser(row)">
                    {{ getCellValue(row, column) }}
                </div>
            </div>
        </div>
    </div>
</div>
